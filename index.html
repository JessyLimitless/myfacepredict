<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-50 min-h-screen flex flex-col items-center justify-center p-4 relative overflow-x-hidden">

  <div class="bg-white shadow-xl rounded-3xl p-6 w-full max-w-xl z-10">
    <h1 class="text-3xl font-extrabold text-center text-pink-600 mb-6">ğŸ¾ ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</h1>

    <div class="flex justify-center mb-4">
      <button id="start-button" onclick="init()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg transition duration-300">
        ğŸ¬ ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°
      </button>
    </div>

    <div class="flex justify-center mb-4">
      <div id="webcam-container" class="w-[250px] sm:w-[300px] h-[250px] sm:h-[300px] border-4 border-yellow-300 rounded-2xl overflow-hidden shadow-md flex items-center justify-center bg-white"></div>
    </div>

    <div id="label-container" class="space-y-4 text-sm text-center mb-6"></div>
    <div id="recommendation-container" class="text-center text-base font-semibold text-purple-700"></div>
  </div>

  <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ«ì ì• ë‹ˆë©”ì´ì…˜ -->
  <div id="countdown" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
              text-8xl font-black text-purple-600 opacity-0 transition duration-500 z-50"></div>

  <!-- AddThis ê³µìœ  ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f6d123456789abc"></script>

  <!-- TensorFlow + Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    const URL = "./my_model/";
    let model, webcam, labelContainer, maxPredictions;
    let isInitialized = false;
    let animationId;

    async function init() {
      if (isInitialized) return;
      isInitialized = true;

      document.getElementById("start-button").disabled = true;
      document.getElementById("start-button").classList.add("opacity-50", "cursor-not-allowed");

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      webcam = new tmImage.Webcam(300, 300, true);
      await webcam.setup();
      await webcam.play();
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");

      loop();
      startCountdown();
    }

    async function loop() {
      webcam.update();
      await predict();
      animationId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        const prob = (prediction[i].probability * 100).toFixed(1);
        const label = prediction[i].className;

        const container = document.createElement("div");
        container.className = "text-left";

        const labelText = document.createElement("div");
        labelText.className = "mb-1 text-sm font-medium text-gray-700";
        labelText.innerText = `${getEmoji(label)} ${label} (${prob}%)`;

        const barBg = document.createElement("div");
        barBg.className = "w-full bg-gray-200 rounded-full h-4";

        const bar = document.createElement("div");
        bar.className = "h-4 rounded-full transition-all duration-500";
        bar.style.width = `${prob}%`;
        bar.style.backgroundColor = getBarColor(i);

        barBg.appendChild(bar);
        container.appendChild(labelText);
        container.appendChild(barBg);
        labelContainer.appendChild(container);
      }
    }

    function startCountdown() {
      const countdown = document.getElementById("countdown");
      let count = 5;

      countdown.textContent = count;
      countdown.classList.remove("opacity-0");
      countdown.classList.add("opacity-100");

      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          countdown.textContent = count;
        } else {
          clearInterval(interval);
          countdown.classList.add("opacity-0");
          stopAndShowFinalResult();
        }
      }, 1000);
    }

    async function stopAndShowFinalResult() {
      cancelAnimationFrame(animationId);
      webcam.stop();
      const prediction = await model.predict(webcam.canvas);

      const sorted = prediction
        .map(p => ({ label: p.className, prob: parseFloat((p.probability * 100).toFixed(1)) }))
        .sort((a, b) => b.prob - a.prob)
        .slice(0, 3);

      const resultText = sorted.map(p => `${getEmoji(p.label)} ${p.label} ${p.prob}%`).join(" + ");
      const mixedDesc = sorted.map(p => getDescription(p.label)).join("\n");

      document.getElementById("recommendation-container").innerHTML = `
        <div class="bg-purple-100 rounded-xl p-4 mt-4 shadow text-center">
          <div class="text-xl font-bold mb-2">${resultText}</div>
          <div class="text-gray-800 whitespace-pre-line text-sm mb-3">${mixedDesc}</div>
          <div class="addthis_inline_share_toolbox"></div>
        </div>
      `;

      if (window.addthis) {
        window.addthis.toolbox('.addthis_inline_share_toolbox');
      }
    }

    function getEmoji(label) {
      if (label.includes("ê°•ì•„ì§€")) return "ğŸ¶";
      if (label.includes("ê³ ì–‘ì´")) return "ğŸ±";
      if (label.includes("í† ë¼")) return "ğŸ°";
      if (label.includes("ì—¬ìš°")) return "ğŸ¦Š";
      if (label.includes("ê³°")) return "ğŸ»";
      if (label.includes("ì‚¬ìŠ´")) return "ğŸ¦Œ";
      if (label.includes("í˜¸ë‘ì´")) return "ğŸ¯";
      if (label.includes("ë§")) return "ğŸ´";
      return "ğŸ¾";
    }

    function getBarColor(index) {
      const colors = ["#f87171", "#60a5fa", "#fbbf24", "#34d399", "#a78bfa", "#f472b6", "#10b981"];
      return colors[index % colors.length];
    }

    function getDescription(label) {
      const map = {
        "ê°•ì•„ì§€": "ë‹¤ì •í•˜ê³  í™œë°œí•˜ë©° ëª¨ë‘ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” ì„±ê²©ì´ì—ìš”.",
        "ê³ ì–‘ì´": "ë„ë„í•˜ê³  ë…ë¦½ì ì¸ ì„±ê²©ì´ì§€ë§Œ ì„¬ì„¸í•œ ë§¤ë ¥ì„ ê°€ì§€ê³  ìˆì–´ìš”.",
        "í† ë¼": "ìˆ˜ì¤ê³  ê·€ì—½ì§€ë§Œ ë”°ëœ»í•œ ë§ˆìŒì„ ê°€ì§„ ì„±ê²©ì´ì—ìš”.",
        "ì—¬ìš°": "ì˜ë¦¬í•˜ê³  ì¬ì¹˜ ìˆìœ¼ë©° ì„¼ìŠ¤ê°€ ë„˜ì¹˜ëŠ” ì„±ê²©ì´ì—ìš”.",
        "ê³°": "ì˜¨í™”í•˜ê³  ë¯¿ìŒì§í•˜ë©° ë“¬ì§í•œ ì„±ê²©ì´ì—ìš”.",
        "ì‚¬ìŠ´": "ë°°ë ¤ì‹¬ ê¹Šê³  ì¡°ìš©í•˜ë©° ê°ìˆ˜ì„±ì´ í’ë¶€í•œ ì„±ê²©ì´ì—ìš”.",
        "í˜¸ë‘ì´": "ì¹´ë¦¬ìŠ¤ë§ˆ ìˆê³  ìì‹ ê° ë„˜ì¹˜ëŠ” ë¦¬ë”í˜• ì„±ê²©ì´ì—ìš”.",
        "ë§": "ììœ ë¡­ê³  ì—ë„ˆì§€ ë„˜ì¹˜ë©° í˜¸ê¸°ì‹¬ì´ ë§ì€ ì„±ê²©ì´ì—ìš”."
      };
      return map[label] || "íŠ¹ë³„í•œ ë§¤ë ¥ì„ ê°€ì§„ ë‹¹ì‹ ë§Œì˜ ì„±ê²©ì´ì—ìš”.";
    }
  </script>
</body>
</html>
